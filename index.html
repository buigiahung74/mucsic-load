<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Uploader & Player</title>
  <style>
    /* Background gradient + subtle animation */
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --accent: rgba(255,255,255,0.9);
      --muted: rgba(255,255,255,0.7);
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial}
    body{
      display:flex;align-items:center;justify-content:center;padding:32px;
      background: linear-gradient(135deg,#0f172a 0%,#0b1220 40%,#06202a 100%);
      background-size:400% 400%;
      animation: bgShift 18s ease-in-out infinite;
      color:var(--accent);
    }
    @keyframes bgShift{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .card{
      width:980px;max-width:100%;border-radius:18px;padding:24px 28px;box-shadow:0 10px 30px rgba(2,6,23,0.6);
      backdrop-filter: blur(8px) saturate(140%);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start;
    }
    header{display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#0ea5e9);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    /* Left area - player */
    .player{
      padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.03);
    }
    .dropzone{
      margin-top:12px;padding:18px;border-radius:12px;border:2px dashed rgba(255,255,255,0.05);display:flex;align-items:center;gap:14px;
      cursor:pointer;transition:all .18s;min-height:96px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.002));
    }
    .dropzone.drag{border-color:rgba(255,255,255,0.14);transform:translateY(-3px)}
    .dropzone input{display:none}
    .dropzone .info{flex:1}
    .dropzone .info strong{display:block}
    .small{font-size:13px;color:var(--muted)}

    .controls{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:var(--accent);cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .btn.play{padding:10px 20px}
    .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;flex:1}
    .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#7c3aed,#0ea5e9)}
    .meta{display:flex;align-items:center;gap:12px;margin-top:12px}
    .meta .title{font-weight:700}
    .meta .sub{color:var(--muted);font-size:13px}

    /* Right area - playlist & settings */
    .sidebar{padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03)}
    .list{max-height:360px;overflow:auto;margin-top:10px;padding:6px}
    .item{padding:10px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;background:rgba(255,255,255,0.01);cursor:pointer}
    .item.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(14,165,233,0.06));border:1px solid rgba(124,58,237,0.08)}
    .item .left{display:flex;gap:10px;align-items:center}
    .item .name{font-weight:600}
    .item .tiny{font-size:12px;color:var(--muted)}
    .settings{margin-top:12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=number], input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)}
    .row{display:flex;gap:10px}
    .muted{color:var(--muted)}
    footer.note{margin-top:10px;color:var(--muted);font-size:12px}

    /* responsive */
    @media (max-width:880px){.card{grid-template-columns:1fr;}
      .sidebar{order:2}
    }
  </style>
</head>
<body>
  <div class="card">
    <div>
      <header>
        <div class="logo">MU</div>
        <div>
          <h1>Music Uploader & Player</h1>
          <p class="lead">Upload MP4 (audio inside) — tạo playlist, loop thông minh, giao diện đẹp, dùng ngay trên trình duyệt.</p>
        </div>
      </header>

      <section class="player">
        <div class="dropzone" id="dropzone" tabindex="0">
          <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#7c3aed,#0ea5e9);display:flex;align-items:center;justify-content:center;font-weight:700">♫</div>
          <div class="info">
            <strong>Nhấn để chọn hoặc kéo thả file MP4 (video/audio)</strong>
            <div class="small">Hỗ trợ nhiều file — sẽ chuyển thành playlist. Dùng cho audio playback (không upload lên server - tất cả cục bộ).</div>
          </div>
          <input id="fileInput" type="file" accept="audio/*,video/mp4,video/*" multiple />
        </div>

        <div class="meta" id="meta">
          <div>
            <div class="title" id="curTitle">Chưa có bài</div>
            <div class="sub" id="curSub">—</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn play" id="playBtn">Play</button>
          <button class="btn" id="prevBtn">⟨ Prev</button>
          <button class="btn" id="nextBtn">Next ⟩</button>
          <div class="progress" id="progressWrap" title="Click to seek">
            <div class="bar" id="progressBar"></div>
          </div>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:90px" />
        </div>

        <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
          <label class="small"><input type="checkbox" id="infiniteLoop" /> Lặp vô hạn</label>
          <label class="small">Lặp số lần: <input id="repeatCount" type="number" min="0" value="0" style="width:76px;margin-left:6px" /></label>
          <button class="btn ghost" id="clearBtn">Clear playlist</button>
        </div>

        <div class="note" style="margin-top:12px;color:var(--muted);font-size:13px">Ghi chú: file được chơi bằng URL cục bộ (ObjectURL). Muốn giữ playlist giữa các lần mở trang, dùng nút Export/Import playlist.</div>

        <!-- hidden audio element -->
        <audio id="audio" preload="auto"></audio>

      </section>
    </div>

    <aside class="sidebar">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong>Playlist</strong>
        <div class="small muted">Các file đã thêm</div>
      </div>

      <div class="list" id="playlist"></div>

      <div class="settings">
        <label>Search playlist</label>
        <input id="search" type="text" placeholder="Tìm theo tên..." />
        <div style="height:10px"></div>
        <div class="row">
          <button class="btn" id="exportBtn">Export .json</button>
          <button class="btn" id="importBtn">Import .json</button>
        </div>
        <div style="height:10px"></div>
        <label>Autoplay on load</label>
        <label class="small"><input id="autoplay" type="checkbox" /> Bật</label>

        <div style="height:12px"></div>
        <label>Tips</label>
        <div class="small muted">Kéo thả file hoặc dùng nút để chọn. File lớn có thể chiếm nhiều RAM.</div>

        <div style="height:8px"></div>
        <footer class="note">Design: smart, responsive, nhiều tính năng: loop, repeat count, playlist search, export/import.</footer>
      </div>
    </aside>
  </div>

  <script>
    // Player logic
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const playlistEl = document.getElementById('playlist');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progressBar');
    const progressWrap = document.getElementById('progressWrap');
    const vol = document.getElementById('vol');
    const curTitle = document.getElementById('curTitle');
    const curSub = document.getElementById('curSub');
    const infiniteLoop = document.getElementById('infiniteLoop');
    const repeatCount = document.getElementById('repeatCount');
    const clearBtn = document.getElementById('clearBtn');
    const search = document.getElementById('search');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const autoplay = document.getElementById('autoplay');

    let playlist = []; // {name, size, url, file}
    let current = -1;
    let repeatRemaining = 0;

    function humanSize(bytes){
      if (bytes<1024) return bytes+' B';
      if (bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB';
      return (bytes/1024/1024).toFixed(2)+' MB';
    }

    function renderPlaylist(filter=''){
      playlistEl.innerHTML='';
      playlist.forEach((it, i) => {
        if (filter && !it.name.toLowerCase().includes(filter.toLowerCase())) return;
        const div = document.createElement('div');
        div.className = 'item' + (i===current? ' active' : '');
        div.innerHTML = `<div class="left"><div style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#7c3aed,#0ea5e9);display:flex;align-items:center;justify-content:center">♪</div><div><div class="name">${escapeHtml(it.name)}</div><div class="tiny">${it.type || 'file'} • ${humanSize(it.size)}</div></div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn" data-i="${i}" data-act="play">▶</button><button class="btn" data-i="${i}" data-act="del">✖</button></div>`;
        playlistEl.appendChild(div);
      });
    }

    function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    function addFiles(files){
      const arr = Array.from(files);
      arr.forEach(f => {
        // accept MP4/video and audio
        const url = URL.createObjectURL(f);
        playlist.push({name:f.name,size:f.size,type:f.type||'unknown',url,file:f});
      });
      if (current===-1 && playlist.length>0){current=0; loadCurrent();}
      renderPlaylist(search.value);
    }

    function loadCurrent(){
      if (current<0 || current>=playlist.length){ audio.pause(); audio.src=''; curTitle.textContent='Chưa có bài'; curSub.textContent='—'; return; }
      const it = playlist[current];
      audio.src = it.url;
      audio.load();
      curTitle.textContent = it.name;
      curSub.textContent = it.type + ' • ' + humanSize(it.size);
      repeatRemaining = Number(repeatCount.value) || 0;
      playState(false);
    }

    function playState(start){
      if (!audio.src) return;
      if (start){ audio.play(); playBtn.textContent='Pause'; }
      else { audio.pause(); playBtn.textContent='Play'; }
    }

    playBtn.addEventListener('click', ()=>{
      if (!audio.src) return alert('Chưa có file để phát.');
      if (audio.paused) { audio.play(); playBtn.textContent='Pause'; }
      else { audio.pause(); playBtn.textContent='Play'; }
    });

    prevBtn.addEventListener('click', ()=>{ if (playlist.length===0) return; current = (current-1+playlist.length)%playlist.length; loadCurrent(); audio.play(); playBtn.textContent='Pause'; renderPlaylist(search.value); });
    nextBtn.addEventListener('click', ()=>{ if (playlist.length===0) return; current = (current+1)%playlist.length; loadCurrent(); audio.play(); playBtn.textContent='Pause'; renderPlaylist(search.value); });

    playlistEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const i = Number(btn.dataset.i);
      const act = btn.dataset.act;
      if (act==='play'){ current = i; loadCurrent(); audio.play(); playBtn.textContent='Pause'; renderPlaylist(search.value); }
      if (act==='del'){ // revoke object url
        if (i===current){ audio.pause(); }
        URL.revokeObjectURL(playlist[i].url);
        playlist.splice(i,1);
        if (i<current) current--;
        if (current>=playlist.length) current = playlist.length-1;
        loadCurrent(); renderPlaylist(search.value);
      }
    });

    audio.addEventListener('timeupdate', ()=>{
      if (!audio.duration || isNaN(audio.duration)) return;
      const pct = (audio.currentTime / audio.duration) * 100;
      progressBar.style.width = pct + '%';
    });

    progressWrap.addEventListener('click', (e)=>{
      if (!audio.duration) return;
      const r = progressWrap.getBoundingClientRect();
      const x = e.clientX - r.left; const pct = x / r.width;
      audio.currentTime = pct * audio.duration;
    });

    vol.addEventListener('input', ()=>{ audio.volume = vol.value; });

    audio.addEventListener('ended', ()=>{
      // loop logic: infiniteLoop OR repeatRemaining > 0 -> replay, else next track
      if (infiniteLoop.checked){ audio.currentTime=0; audio.play(); return; }
      if (Number(repeatCount.value) > 0){ if (repeatRemaining>0){ repeatRemaining--; audio.currentTime=0; audio.play(); return; } }
      // next
      if (playlist.length>0){ current = (current+1)%playlist.length; loadCurrent(); audio.play(); }
    });

    // file input / drag & drop
    dropzone.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> addFiles(e.target.files));

    ['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('drag'); }));
    dropzone.addEventListener('drop', (e)=>{
      const dt = e.dataTransfer; if (!dt) return; addFiles(dt.files);
    });

    clearBtn.addEventListener('click', ()=>{
      playlist.forEach(it=>{ try{ URL.revokeObjectURL(it.url);}catch(e){} });
      playlist = []; current = -1; loadCurrent(); renderPlaylist();
    });

    search.addEventListener('input', ()=> renderPlaylist(search.value));

    // export / import playlist metadata (not file blobs) - user can re-add files later
    exportBtn.addEventListener('click', ()=>{
      const data = playlist.map(it=>({name:it.name,size:it.size,type:it.type}));
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'playlist.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    importBtn.addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = (e)=>{
        const f = e.target.files[0]; if (!f) return; const r=new FileReader(); r.onload = ()=>{ try{ const data=JSON.parse(r.result); alert('Import chỉ thêm tên/metadata. Bạn cần thêm file thực tế bằng cách kéo thả cùng tên nếu muốn khôi phục.'); console.log(data);}catch(e){alert('File không hợp lệ')} }; r.readAsText(f);
      }; inp.click();
    });

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (e.code==='Space' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); playBtn.click(); }
      if (e.key==='ArrowRight') nextBtn.click();
      if (e.key==='ArrowLeft') prevBtn.click();
    });

    // initialize
    vol.value = 0.9; audio.volume = 0.9;
    // support clicking items to play
    playlistEl.addEventListener('click', (e)=>{})

    // helpful safety: revoke urls when page unloaded
    window.addEventListener('beforeunload', ()=>{ playlist.forEach(it=>{ try{ URL.revokeObjectURL(it.url)}catch(e){} }); });

    // autoplay option
    autoplay.addEventListener('change', ()=>{ if (autoplay.checked && playlist.length>0){ current=0; loadCurrent(); audio.play(); playBtn.textContent='Pause'; }});

    // accept keyboard focus for dropzone
    dropzone.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') fileInput.click(); });

  </script>
</body>
</html>
